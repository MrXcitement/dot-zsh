#!/usr/bin/env bash

# install-- make symbolic links in the users home directory
# Mike Barker <mike@thebarkers.com>
# May 14th, 2013

# Backup a file/directory by renaming it with the current date and time
backup_file() {
	file=$1

    [[ ${DEBUG} ]] && printf "backup_file:\n\tfile: %s\n" "${file}"

	if [ -e "${file}" ]; then
		if ! [ -h "${file}" ]; then
            file_ext=$(date +%Y%m%d%H%M)
			printf "Backup: %s\n    to: %s\n" "${file}" "${file}.${file_ext}"
			mv "${file}" "${file}.${file_ext}"
		fi
	fi
}

# create a symbolic link if one does not allready exist
link_file() {
    local target=$1
    local link=$2

    link_dir=$(dirname "${link}")

    [[ ${DEBUG} ]] && printf "link_file:\n\ttarget: %s\n\tlink: %s\n\tlink_dir: %s\n" "${target}" "${link}" "${link_dir}"

    if ! [ -e "${link_dir}" ]; then
        echo "Make directory: ${link_dir}"
        mkdir -p "${link_dir}"
    fi

    if ! [ -e "${link}" ]; then
        echo "Link: ${link}"
        ln -sfnv "${target}" "${link}"
    fi
}

# Backup existing files and link files/dirs in the home folder into
# the users home directory.
DIR="$(cd "$(dirname "$0")" && pwd)"
TARGET_ITEMS=(
    "home/.config/*"
    "home/.z*"
)
shopt -s dotglob
for item in ${TARGET_ITEMS[*]}; do
    link="${item/home/${HOME}}"
    target="${DIR}/${item}"
    [[ ${DEBUG} ]] && printf "item: %s\ntarget: %s\nlink: %s\n" "${item}" "${target}" "${link}"
    backup_file "${link}"
    link_file "$target" "$link"
done
shopt -u dotglob
